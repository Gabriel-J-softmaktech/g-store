$(document).ready(function(){
    
    function fetchAllProducts(){
        $.ajax({
            url: '/product-list/',
            dataTyp: 'json',
            data: {'get_product': true},
            beforeSend(){
                console.log("loading..")
            },
            success: function(resp){
                $("#product_loader").html(resp.data)
            },
            error: function(hxr, status, error){
                console.log(status+": "+error)
            },
        });
    }
    fetchAllProducts();


    // User registration
    $("body").on("submit", ".registration", function(e){
        e.preventDefault();

        const fname = $('#fname').val()
        const lname = $('#lname').val()
        const email = $('#email').val()
        const mobile = $('#mobile-number').val()
        const address = $('#address').val()
        const password = $('#password').val()
        const cpassword = $('#cpassword').val()
        const csrftoken = $('input[name=csrfmiddlewaretoken]').val()
        
        if (password.length < 6){
            alert("Provided password is too short.");
            $("#password").css({"border": "1px solid #e33"})
            exit();
        }
        else if(cpassword != password){
            alert("Password confimation didn't match provided password.");
            exit();
        }else{
            
            $.ajax({

                url: "/user-registration/",
                method: 'POST',
                data: {
                    "fname": fname,
                    "lname": lname,
                    "email": email,
                    'mobile': mobile,
                    "address": address,
                    "password": password,
                    'csrfmiddlewaretoken': csrftoken,
                },
                'csrfmiddlewaretoken': csrftoken,
                beforeSend: function(){
                    $(".registration-btn").addClass('disabled', true);
                    $('.btn-icon').removeClass('fa-user', true);
                    $('.btn-icon').addClass('fa-spinner', true);
                },
                success: function(resp){
                    $(".registration-btn").removeClass('disabled', true);
                    $('.btn-icon').removeClass('fa-spinner', true);
                    $('.btn-icon').addClass('fa-user', true);
                    if(resp.data == 200){
                        alert(resp.data)
                        window.location.href="/auth-cart/"
                    }
                    else if(resp.data == 'No data in session cart'){
                        window.location.href="/account/"
                    }
                    else if(resp.data == 300){
                        $(".msg").html("<div class='alert alert-danger'><b>"+email+"</b> is associated with a user account.</div>");
                       setTimeout(function(){
                        $(".msg").fadeOut('slow');
                       }, 5000)
                    }
                },
                error: function(hrx, status, error){
                    alert(status+": "+error);
                    $(".registration-btn").removeClass('disabled', true);
                    $('.btn-icon').removeClass('fa-spinner', true);
                    $('.btn-icon').addClass('fa-user', true);
                }
            });

        }

    });

    $("body").on("submit", "#loginForm", function(e){
        e.preventDefault();

        const email = $("#email").val();
        const password = $("#password").val();
        const csrftoken = $("input[name='csrfmiddlewaretoken']").val();

        $.ajax({
            url: '/login-user/',
            method: 'POST',
            data: {
                'email': email,
                'password': password,
                'csrfmiddlewaretoken': csrftoken,
            },
            'csrfmiddlewaretoken': csrftoken,
            beforeSend: function(){
                $("#login-btn").addClass("disabled", true);
            },
            success: function(resp){
                if(resp.data == 200){
                    $("#login-btn").removeClass("disabled", true);
                    $(".msg").html("<div class='alert alert-success'><i class='fa fa-mark-circle'></i> Successfully logging you in..!</div>");
                    setTimeout(function(){
                        window.location.href="/"
                    }, 3000)
                }
                if(resp.data == 300){
                    $("#login-btn").removeClass("disabled", true);
                    $(".msg").html("<div class='alert alert-danger'><i class='fa fa-key'></i> Incorrect credentials</div>");
                }
                if(resp.data == 500){
                    $("#login-btn").removeClass("disabled", true);
                    $(".msg").html("<div class='alert alert-danger'><i class='fa fa-times-circle'></i> Internal Error.</div>");
                }
            }
        });

    });

   
});