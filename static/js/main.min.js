$(document).ready(function(){

    function StoreLoaderScreen() {
        $("#product_loader").html(
            '<div class="preloaderDiv">'
            +'<span class="spinner-border spinner-border-lg text-secondary" role="status" aria-hidden="true"></span>'
            +'<p style="color: #ddd; padding: 5px;">Loading..!</p>'
            +'</div>'
        );

        $(".preloaderDiv").css({
            'height': '100hv',
            'display': 'flex',
            'flex-direction': 'column',
            'justify-content': 'center',
            'align-items': 'center',
            'margin-top': '25%',
        });
    }
    
    function fetchAllProducts(){
        $.ajax({
            url: '/product-list/',
            dataTyp: 'json',
            data: {'get_product': true},
            beforeSend(){
                StoreLoaderScreen();
            },
            success: function(resp){
                $("#product_loader").html(resp.products);
                $(".categories").html(resp.categories);
            },
            error: function(hxr, status, error){
                console.log(status+": "+error)
            },
        });
    }
    fetchAllProducts();

    $("body").on("keyup", ".search-input", function(){
        const keyword = $('#search-product-input').val();
        const csrftoken = $("input[name=csrfmiddlewaretoken]").val();
        if (keyword.length > 0){
            $.ajax({
                url: '/filter-product-by-search/',
                method: 'POST',
                data: {
                    'keyword': keyword,
                    'csrfmiddlewaretoken': csrftoken
                },
                beforeSend: function(){
                    StoreLoaderScreen();
                },
                success: function(resp){
                    if(resp.response == 200){
                        $("#product_loader").html(resp.searched_product)
                    }else{
                        $("#product_loader").css({"margin": "50px"})
                        $("#product_loader").html(
                            "<div class='alert alert-secondary'>"+
                                "<i class='fa fa-times-circle p-1'></i>"
                                +" Sorry we can find your order at the moment "+
                                "but we do have other greate stuff you might like too."
                                +"</div>"
                        );
                    }
                },
                error: function(hxr, status, err){
                    console.log(err)
                }
            });
        }else{
            // reloading product if key is empty or less than 0 or equal 0
            fetchAllProducts();
        }

    });

    // Slider - price range controller
    $("body").on("blur", "#maxPrice", function(){
        var _min = $(this).attr("min");
        var _max = $(this).attr("max");
        var _val = $(this).val();

        console.log("min: "+_min+" "+"max: "+_max+" "+"val: "+_val);

        if(_val < parseInt(_min) || _val > parseInt(_max)){
            $(this).val(_min);
            $(this).focus();
            $("#rangeInput").val(_max);
        }
    });


    // filter by category
    $(".filter-checkbox, #PriceFilterBtn").on("click", function(){
      
        var _filterObj = {};
        var _minPrice = $('#maxPrice').attr("min");
        var _maxPrice = $('#maxPrice').val();

        _filterObj.minPrice = _minPrice;
        _filterObj.maxPrice = _maxPrice;

        $(".filter-checkbox").each(function(index, ele){
            var _filterCategory = $(this).data("filter");

            _filterObj[_filterCategory] = Array.from(
                document.querySelectorAll("input[data-filter="+ _filterCategory +"]:checked")
                ).map(function(el){
                    return el.value;
                });
        });
        $.ajax({
            url: '/filter-product-by-category/',
            dataTyp: 'json',
            data: _filterObj,
            beforeSend(){
                StoreLoaderScreen();
            },
            success: function(resp){
                if (resp.filtered_product != ""){
                    $("#product_loader").html(resp.filtered_product);
                }else{
                    $("#product_loader").css({"margin": "50px"})
                    $("#product_loader").html(
                        "<div class='alert alert-secondary'>"+
                            "<i class='fa fa-times-circle p-1'></i>"
                            +" Sorry we can find your order at the moment "+
                            "but we do have other greate stuff you might like too."
                            +"</div>"
                    );
                }
            },
            error: function(hxr, status, error){
                console.log(status+": "+error)
            },
        });
    });


    // Fetching customer/or user ordered products
    const FetchCustomerOrder = () =>{
        $.ajax({
            url: "/orders/",
            methon: "GET",
            dataType: "json",
            data: {"customerOrder":1},
            beforeSend: function(){
                console.log("Loading..")
            },
            success: function(resp){
                $("#ordered_product_loader").html(resp.order);
                $("#total_order").html(resp.total_order);
                $("#total_item_in_cart").html(resp.total_item_in_cart);
                $("#total_pending").html(resp.total_pending);
                $("#total_delivered").html(resp.total_delivered);
            },
            error: function(hxr, status, error){
                console.log(status+": "+error)
            }
        });
    }
    FetchCustomerOrder();

    $("body").on("click", ".delete-order", function(){
        const product_id = $(this).data("order");
        $.ajax({
            url: "/delete-order/",
            methon: "GET",
            dataType: "json",
            data: {"product_id":product_id},
            beforeSend: function(){
                console.log("Loading..")
            },
            success: function (resp){
                if(resp.data == 200){
                    $(".message").css({"display": "block"})
                    $(".message").html("<div class='alert alert-success'><i class='fa fa-okey-circle'></i> Order deleted</div>")
                    FetchCustomerOrder();
                }
            },
            error: function(hxr, status, error){
                console.log(status+": "+error);
            }
        });
    })



    // User registration
    $('.registration-preloader').css({'display': 'none'});
    $("body").on("submit", ".registration", function(e){
        e.preventDefault();

        const fname = $('#fname').val();
        const lname = $('#lname').val();
        const email = $('#email').val();
        const mobile = $('#mobile-number').val();
        const country = $('#country').val();
        const city = $('#city').val();
        const address = $('#address').val();
        const password = $('#password').val();
        const cpassword = $('#cpassword').val();
        const csrftoken = $('input[name=csrfmiddlewaretoken]').val();

        if (fname.length <= 3){
            $(".fname-error").text("Please provide a valid first name.");
            $("#fname").css({"border": "1px solid #e33"});
            $(".fname-error").css({"color": "#e55", "font-size": "11px"});
            exit();
        }

        else if (lname.length <= 3){
            $(".lname-error").text("Please provide a valid last name.");
            $("#lname").css({"border": "1px solid #e33"});
            $(".lname-error").css({"color": "#e55", "font-size": "11px"});
            exit();
        }

        else if (mobile.length < 11 || mobile.length > 15){
            $(".mobile-error").text("Please provide a valid mobile contact number.");
            $("#mobile-number").css({"border": "1px solid #e33"});
            $(".mobile-error").css({"color": "#e55", "font-size": "11px"});
            exit();
        }

        else if (country.length <= 3){
            $(".country-error").text("Please provide a valid country name.");
            $("#country").css({"border": "1px solid #e33"});
            $(".country-error").css({"color": "#e55", "font-size": "11px"});
            exit();
        }

        else if (city.length <= 3){
            $(".city-error").text("Please provide a valid city name.");
            $("#city").css({"border": "1px solid #e33"});
            $(".city-error").css({"color": "#e55", "font-size": "11px"});
            exit();
        }

        else if (address.length <= 3){
            $(".address-error").text("Please enter a correct residential address.");
            $("#address").css({"border": "1px solid #e33"});
            $(".address-error").css({"color": "#e55", "font-size": "11px"});
            exit();
        }
        
        else if (password.length < 6){
            $(".password-error").text("Provided password is too short.");
            $("#password").css({"border": "1px solid #e33"});
            $(".password-error").css({"color": "#e55", "font-size": "11px"});
            exit();
        }
        else if(cpassword != password){
            $(".cpassword-error").text("Password confimation didn't match provided password.");
            $("#cpassword").css({"border": "1px solid #e33"});
            $(".cpassword-error").css({"color": "#e55", "font-size": "11px"});
            exit();
        }else{
            
            $.ajax({

                url: "/user-registration/",
                method: 'POST',
                data: {
                    "fname": fname,
                    "lname": lname,
                    "email": email,
                    "mobile": mobile,
                    "country": country,
                    "city": city,
                    "address": address,
                    "password": password,
                    "csrfmiddlewaretoken": csrftoken,
                },
                'csrfmiddlewaretoken': csrftoken,
                beforeSend: function(){
                    $('.registration-preloader').css({'display': 'inline-block'});
                    $(".registration-btn").addClass('disabled', true);
                },
                success: function(resp){
                    $(".registration-btn").removeClass('disabled', true);
                    $('.registration-preloader').css({'display': 'none'});
                    if(resp.data == 200){
                        alert(resp.data)
                        $("#msg").html("<div class='alert alert-success'>Registration was successful, and we'll log you in now!</div>");
                        setTimeout(function(){
                            window.location.href="/"
                        }, 3000)
                    }
                    else if(resp.data == 503){
                        $("#msg").show();
                        $("#msg").html("<div class='alert alert-danger'>Network Error! please make sure you're connected to the internet.</div>");
                        $('.registration-preloader').css({'display': 'none'});
                        setTimeout(function(){
                        $("#msg").fadeOut('slow');
                        }, 3000);
                    }
                    else if(resp.data == 300){
                        $("#msg").show();
                        $("#msg").html("<div class='alert alert-danger'><b>"+email+"</b> is already associated with a user account!</div>");
                        $('.registration-preloader').css({'display': 'none'});
                        setTimeout(function(){
                        $("#msg").fadeOut('slow');
                       }, 3000);
                    }
                },
                error: function(hrx, status, error){
                    alert(status+": "+error);
                    $(".registration-btn").removeClass('disabled', true);
                    $('.btn-icon').removeClass('fa-spinner', true);
                    $('.btn-icon').addClass('fa-user', true);
                    $('.registration-preloader').css({'display': 'none'});
                }
            });

        }

    });


    $(".login-preloader").css({'display': 'none'});
    $("body").on("submit", "#loginForm", function(e){
        e.preventDefault();

        const email = $("#email").val();
        const password = $("#password").val();
        const csrftoken = $("input[name='csrfmiddlewaretoken']").val();

        $.ajax({
            url: '/login-user/',
            method: 'POST',
            data: {
                'email': email,
                'password': password,
                'csrfmiddlewaretoken': csrftoken,
            },
            'csrfmiddlewaretoken': csrftoken,
            beforeSend: function(){
                $("#login-btn").addClass("disabled", true);
                $(".login-preloader").css({'display': 'inline-block'});
            },
            success: function(resp){
                if(resp.data == 200){
                    $("#login-btn").removeClass("disabled", true);
                    $(".msg").html("<div class='alert alert-success'><i class='fa fa-mark-circle'></i> Successfully logging you in..!</div>");
                    $(".login-preloader").css({'display': 'none'});
                    setTimeout(function(){
                        $(".msg").fadeOut('slow');
                    }, 3000);
                    setTimeout(function(){
                        window.location.href="/"
                    }, 3500);
                }
                if(resp.data == 300){
                    $(".msg").show();
                    $("#login-btn").removeClass("disabled", true);
                    $(".msg").html("<div class='alert alert-danger'><i class='fa fa-key'></i> Incorrect credentials</div>");
                    $(".login-preloader").css({'display': 'none'});
                    setTimeout(function(){
                        $(".msg").fadeOut('slow');
                    }, 3000);
                }
                if(resp.data == 500){
                    $(".msg").show();
                    $("#login-btn").removeClass("disabled", true);
                    $(".msg").html("<div class='alert alert-danger'><i class='fa fa-times-circle'></i> Internal Error.</div>");
                    $(".login-preloader").css({'display': 'none'});
                    setTimeout(function(){
                        $(".msg").fadeOut('slow');
                    }, 3000);
                }
            }
        });

    });

    // customer account settings
    $("body").on("submit", ".change-personal-info-form", function(e){
        e.preventDefault();
        
        const csrftoken = $("input[name=csrfmiddlewaretoken]").val();
        var firstname = $("#fname").val();
        var lastname = $("#lname").val();
        var email = $("#email").val();
        var mobile = $("#mobile").val();
        var country = $("#country").val();
        var city = $("#city").val();
        var address = $("#address").val();

        $.ajax({
            url: '/update-info/',
            method: 'POST',
            data: {
                'fname': firstname,
                'lname': lastname,
                'email': email,
                'mobile': mobile,
                'country': country,
                'city': city,
                'address': address,
                'csrfmiddlewaretoken': csrftoken,
            },
            'csrfmiddlewaretoken': csrftoken,
            beforeSend: function(){
                console.log("Loading...!");
                $(".save-customer-info-btn").addClass("disabled", true);
            },
            success: function(resp){
                if (resp.email_exist == 200){
                    $(".form-message").html("<div class='alert alert-success'>Personal information has been successfully saved.</div>");
                    $(".email-error").text("Provided email is associated to an account!");
                    $(".email-error").css({"color": "#FFB04B", "font-size": "11px"});
                    $(".save-customer-info-btn").removeClass("disabled", true);
                }else if (resp.data == 200){
                    $(".form-message").html("<div class='alert alert-success'>Personal information has been successfully saved.</div>");
                    $(".save-customer-info-btn").removeClass("disabled", true);
                }
            },
            error: function(hrx, status, error){
                console.log(status+": "+error);
            }
        });
    });

    $("body").on("submit", ".change-password-form", function(e){
        e.preventDefault();

        var new_password = $("#new_password").val();
        var confirm_password = $("#confirm_password").val();

        if (new_password.length <= 5){

        }
        else if(new_password == old_password){

        }

    });

   
});